{"version":3,"sources":["../../src/migration/list-item-references-to-value-objects.js"],"names":["MIGRATABLE_COMPONENT_TYPES","ListItemReferencesToValueObjects","constructor","server","logger","Logger","getInitialVersion","migrate","formDef","version","pages","forEach","page","components","component","migrateComponent","includes","type","options","list","listName","lists","find","name","values","valueChildren","items","filter","item","conditional","map","value","children","it","error"],"mappings":";;;;;;;;;;;AACA;;AAEA,MAAMA,0BAA0B,GAAG,CAAC,aAAD,EAAgB,iBAAhB,EAAmC,YAAnC,EAAiD,aAAjD,EAAgE,mBAAhE,EAAqF,MAArF,EAA6F,WAA7F,CAAnC;;AAEe,MAAMC,gCAAN,CAA4D;AAGzEC,EAAAA,WAAW,CAAEC,MAAF,EAAU;AAAA;AACnB,SAAKC,MAAL,GAAc,IAAIC,cAAJ,CAAWF,MAAX,EAAmB,kCAAnB,CAAd;AACD;;AAEDG,EAAAA,iBAAiB,GAAI;AACnB,WAAO,CAAP;AACD;;AAEDC,EAAAA,OAAO,CAAEC,OAAF,EAAsB;AAC3BA,IAAAA,OAAO,CAACC,OAAR,GAAkBD,OAAO,CAACC,OAAR,IAAmB,CAArC;AACAD,IAAAA,OAAO,CAACE,KAAR,CAAcC,OAAd,CAAsBC,IAAI,IAAI;AAC5BA,MAAAA,IAAI,CAACC,UAAL,CAAgBF,OAAhB,CAAwBG,SAAS,IAAI;AACnC,aAAKC,gBAAL,CAAsBD,SAAtB,EAAiCN,OAAjC;AACD,OAFD;AAGD,KAJD;AAKA,WAAOA,OAAP;AACD;;AAEDO,EAAAA,gBAAgB,CAAED,SAAF,EAAaN,OAAb,EAAsB;AAAA;;AACpC,QAAIR,0BAA0B,CAACgB,QAA3B,CAAoCF,SAAS,CAACG,IAA9C,4BAAuDH,SAAS,CAACI,OAAjE,uDAAuD,mBAAmBC,IAA1E,CAAJ,EAAoF;AAClF,YAAMC,QAAQ,GAAGN,SAAS,CAACI,OAAV,CAAkBC,IAAnC;AACA,YAAMA,IAAI,GAAGX,OAAO,CAACa,KAAR,CAAcC,IAAd,CAAmBH,IAAI,IAAIA,IAAI,CAACI,IAAL,KAAcH,QAAzC,CAAb;;AACA,UAAID,IAAJ,EAAU;AACRL,QAAAA,SAAS,CAACU,MAAV,GAAmB;AACjBP,UAAAA,IAAI,EAAE,SADW;AAEjBE,UAAAA,IAAI,EAAEA,IAAI,CAACI,IAFM;AAGjBE,UAAAA,aAAa,EAAEN,IAAI,CAACO,KAAL,CAAWC,MAAX,CAAkBC,IAAI;AAAA;;AAAA,wCAAIA,IAAI,CAACC,WAAT,sDAAI,kBAAkBhB,UAAtB;AAAA,WAAtB,EACZiB,GADY,CACRF,IAAI,KAAK;AAAEG,YAAAA,KAAK,EAAEH,IAAI,CAACG,KAAd;AAAqBC,YAAAA,QAAQ,EAAEJ,IAAI,CAACC,WAAL,CAAiBhB,UAAjB,CAA4BiB,GAA5B,CAAgCG,EAAE,IAAI,KAAKlB,gBAAL,CAAsBkB,EAAtB,EAA0BzB,OAA1B,CAAtC;AAA/B,WAAL,CADI;AAHE,SAAnB;AAMA,eAAOM,SAAS,CAACI,OAAV,CAAkBC,IAAzB;AACD,OARD,MAQO;AACL,aAAKf,MAAL,CAAY8B,KAAZ,CAAmB,8CAA6Cd,QAAS,2CAAzE;AACD;AACF;;AACD,WAAON,SAAP;AACD;;AAtCwE","sourcesContent":["import type { Migration } from './schema-migrations'\nimport { Logger } from '../logger'\n\nconst MIGRATABLE_COMPONENT_TYPES = ['RadiosField', 'CheckboxesField', 'YesNoField', 'SelectField', 'AutocompleteField', 'List', 'FlashCard']\n\nexport default class ListItemReferencesToValueObjects implements Migration {\n  logger: Logger\n\n  constructor (server) {\n    this.logger = new Logger(server, 'ListItemReferencesToValueObjects')\n  }\n\n  getInitialVersion () {\n    return 0\n  }\n\n  migrate (formDef: any) : any {\n    formDef.version = formDef.version || 1\n    formDef.pages.forEach(page => {\n      page.components.forEach(component => {\n        this.migrateComponent(component, formDef)\n      })\n    })\n    return formDef\n  }\n\n  migrateComponent (component, formDef) {\n    if (MIGRATABLE_COMPONENT_TYPES.includes(component.type) && component.options?.list) {\n      const listName = component.options.list\n      const list = formDef.lists.find(list => list.name === listName)\n      if (list) {\n        component.values = {\n          type: 'listRef',\n          list: list.name,\n          valueChildren: list.items.filter(item => item.conditional?.components)\n            .map(item => ({ value: item.value, children: item.conditional.components.map(it => this.migrateComponent(it, formDef)) }))\n        }\n        delete component.options.list\n      } else {\n        this.logger.error(`Unable to migrate component with list name ${listName} as the corresponding list does not exist`)\n      }\n    }\n    return component\n  }\n}\n"],"file":"list-item-references-to-value-objects.js"}