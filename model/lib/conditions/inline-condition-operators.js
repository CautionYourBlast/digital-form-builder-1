"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getOperatorNames = getOperatorNames;
exports.getExpression = getExpression;
exports.getOperatorConfig = getOperatorConfig;
exports.relativeDateOrTimeOperatorNames = exports.absoluteDateOrTimeOperatorNames = exports.customOperators = void 0;

var _inlineConditionValues = require("./inline-condition-values");

var defaultOperators = {
  is: inline('=='),
  'is not': inline('!=')
};

function withDefaults(param) {
  return Object.assign({}, param, defaultOperators);
}

var textBasedFieldCustomisations = {
  'is longer than': lengthIs('>'),
  'is shorter than': lengthIs('<'),
  'has length': lengthIs('==')
};
var absoluteDateTimeOperators = {
  is: absoluteDateTime('=='),
  'is not': absoluteDateTime('!='),
  'is before': absoluteDateTime('<'),
  'is after': absoluteDateTime('>')
};

var relativeTimeOperators = function relativeTimeOperators(units) {
  return {
    'is at least': relativeTime('<=', '>=', units),
    'is at most': relativeTime('>=', '<=', units),
    'is less than': relativeTime('>', '<', units),
    'is more than': relativeTime('<', '>', units)
  };
};

var customOperators = {
  CheckboxesField: {
    contains: reverseInline('in'),
    'does not contain': not(reverseInline('in'))
  },
  NumberField: withDefaults({
    'is at least': inline('>='),
    'is at most': inline('<='),
    'is less than': inline('<'),
    'is more than': inline('>')
  }),
  DateField: Object.assign({}, absoluteDateTimeOperators, relativeTimeOperators(_inlineConditionValues.dateUnits)),
  TimeField: Object.assign({}, absoluteDateTimeOperators, relativeTimeOperators(_inlineConditionValues.timeUnits)),
  DatePartsField: Object.assign({}, absoluteDateTimeOperators, relativeTimeOperators(_inlineConditionValues.dateUnits)),
  DateTimeField: Object.assign({}, absoluteDateTimeOperators, relativeTimeOperators(_inlineConditionValues.dateTimeUnits)),
  DateTimePartsField: Object.assign({}, absoluteDateTimeOperators, relativeTimeOperators(_inlineConditionValues.dateTimeUnits)),
  TextField: withDefaults(textBasedFieldCustomisations),
  MultilineTextField: withDefaults(textBasedFieldCustomisations),
  EmailAddressField: withDefaults(textBasedFieldCustomisations)
};
exports.customOperators = customOperators;

function getOperatorNames(fieldType) {
  return Object.keys(getConditionals(fieldType)).sort();
}

function getExpression(fieldType, fieldName, operator, value) {
  return getConditionals(fieldType)[operator].expression({
    type: fieldType,
    name: fieldName
  }, value);
}

function getOperatorConfig(fieldType, operator) {
  return getConditionals(fieldType)[operator];
}

function getConditionals(fieldType) {
  return customOperators[fieldType] || defaultOperators;
}

function inline(operator) {
  return {
    expression: function expression(field, value) {
      return "".concat(field.name, " ").concat(operator, " ").concat(formatValue(field.type, value.value));
    }
  };
}

function lengthIs(operator) {
  return {
    expression: function expression(field, value) {
      return "length(".concat(field.name, ") ").concat(operator, " ").concat(value.value);
    }
  };
}

function reverseInline(operator) {
  return {
    expression: function expression(field, value) {
      return "".concat(formatValue(field.type, value.value), " ").concat(operator, " ").concat(field.name);
    }
  };
}

function not(operatorDefinition) {
  return {
    expression: function expression(field, value) {
      return "not (".concat(operatorDefinition.expression(field, value), ")");
    }
  };
}

function formatValue(fieldType, value) {
  if (fieldType === 'NumberField' || fieldType === 'YesNoField') {
    return value;
  }

  return "'".concat(value, "'");
}

var absoluteDateOrTimeOperatorNames = Object.keys(absoluteDateTimeOperators);
exports.absoluteDateOrTimeOperatorNames = absoluteDateOrTimeOperatorNames;
var relativeDateOrTimeOperatorNames = Object.keys(relativeTimeOperators(_inlineConditionValues.dateTimeUnits));
exports.relativeDateOrTimeOperatorNames = relativeDateOrTimeOperatorNames;

function absoluteDateTime(operator) {
  return {
    expression: function expression(field, value) {
      if (value instanceof _inlineConditionValues.ConditionValue) {
        return "".concat(field.name, " ").concat(operator, " '").concat(value.toExpression(), "'");
      }

      throw Error('only Value types are supported');
    }
  };
}

function relativeTime(pastOperator, futureOperator, units) {
  return {
    units: units,
    expression: function expression(field, value) {
      if (value instanceof _inlineConditionValues.RelativeTimeValue) {
        var operator = value.direction === _inlineConditionValues.dateDirections.PAST ? pastOperator : futureOperator;
        return "".concat(field.name, " ").concat(operator, " ").concat(value.toExpression());
      }

      throw Error('time shift requires a TimeShiftValue');
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25kaXRpb25zL2lubGluZS1jb25kaXRpb24tb3BlcmF0b3JzLmpzIl0sIm5hbWVzIjpbImRlZmF1bHRPcGVyYXRvcnMiLCJpcyIsImlubGluZSIsIndpdGhEZWZhdWx0cyIsInBhcmFtIiwiT2JqZWN0IiwiYXNzaWduIiwidGV4dEJhc2VkRmllbGRDdXN0b21pc2F0aW9ucyIsImxlbmd0aElzIiwiYWJzb2x1dGVEYXRlVGltZU9wZXJhdG9ycyIsImFic29sdXRlRGF0ZVRpbWUiLCJyZWxhdGl2ZVRpbWVPcGVyYXRvcnMiLCJ1bml0cyIsInJlbGF0aXZlVGltZSIsImN1c3RvbU9wZXJhdG9ycyIsIkNoZWNrYm94ZXNGaWVsZCIsImNvbnRhaW5zIiwicmV2ZXJzZUlubGluZSIsIm5vdCIsIk51bWJlckZpZWxkIiwiRGF0ZUZpZWxkIiwiZGF0ZVVuaXRzIiwiVGltZUZpZWxkIiwidGltZVVuaXRzIiwiRGF0ZVBhcnRzRmllbGQiLCJEYXRlVGltZUZpZWxkIiwiZGF0ZVRpbWVVbml0cyIsIkRhdGVUaW1lUGFydHNGaWVsZCIsIlRleHRGaWVsZCIsIk11bHRpbGluZVRleHRGaWVsZCIsIkVtYWlsQWRkcmVzc0ZpZWxkIiwiZ2V0T3BlcmF0b3JOYW1lcyIsImZpZWxkVHlwZSIsImtleXMiLCJnZXRDb25kaXRpb25hbHMiLCJzb3J0IiwiZ2V0RXhwcmVzc2lvbiIsImZpZWxkTmFtZSIsIm9wZXJhdG9yIiwidmFsdWUiLCJleHByZXNzaW9uIiwidHlwZSIsIm5hbWUiLCJnZXRPcGVyYXRvckNvbmZpZyIsImZpZWxkIiwiZm9ybWF0VmFsdWUiLCJvcGVyYXRvckRlZmluaXRpb24iLCJhYnNvbHV0ZURhdGVPclRpbWVPcGVyYXRvck5hbWVzIiwicmVsYXRpdmVEYXRlT3JUaW1lT3BlcmF0b3JOYW1lcyIsIkNvbmRpdGlvblZhbHVlIiwidG9FeHByZXNzaW9uIiwiRXJyb3IiLCJwYXN0T3BlcmF0b3IiLCJmdXR1cmVPcGVyYXRvciIsIlJlbGF0aXZl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Q0ksS0FBRCxFQUFRTCxLQUFSLEVBQWtCO0FBQzVCLFVBQUlBLEtBQUssWUFBWVUscUNBQXJCLEVBQXFDO0FBQ25DLHlCQUFVTCxLQUFLLENBQUNGLElBQWhCLGNBQXdCSixRQUF4QixlQUFxQ0MsS0FBSyxDQUFDVyxZQUFOLEVBQXJDO0FBQ0Q7O0FBQ0QsWUFBTUMsS0FBSyxDQUFDLGdDQUFELENBQVg7QUFDRDtBQU5JLEdBQVA7QUFRRDs7QUFFRCxTQUFTdEMsWUFBVCxDQUF1QnVDLFlBQXZCLEVBQXFDQyxjQUFyQyxFQUFxRHpDLEtBQXJELEVBQTREO0FBQzFELFNBQU87QUFDTEEsSUFBQUEsS0FBSyxFQUFFQSxLQURGO0FBRUw0QixJQUFBQSxVQUFVLEVBQUUsb0JBQUNJLEtBQUQsRUFBUUwsS0FBUixFQUFrQjtBQUM1QixVQUFJQSxLQUFLLFlBQVllLHdDQUFyQixFQUF3QztBQUN0QyxZQUFNaEIsUUFBUSxHQUFHQyxLQUFLLENBQUNnQixTQUFOLEtBQW9CQyxzQ0FBZUMsSUFBbkMsR0FBMENMLFlBQTFDLEdBQXlEQyxjQUExRTtBQUNBLHlCQUFVVCxLQUFLLENBQUNGLElBQWhCLGNBQXdCSixRQUF4QixjQUFvQ0MsS0FBSyxDQUFDVyxZQUFOLEVBQXBDO0FBQ0Q7O0FBQ0QsWUFBTUMsS0FBSyxDQUFDLHNDQUFELENBQVg7QUFDRDtBQVJJLEdBQVA7QUFVRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbmRpdGlvblZhbHVlLFxuICBkYXRlRGlyZWN0aW9ucyxcbiAgZGF0ZVRpbWVVbml0cyxcbiAgZGF0ZVVuaXRzLFxuICBSZWxhdGl2ZVRpbWVWYWx1ZSxcbiAgdGltZVVuaXRzXG59IGZyb20gJy4vaW5saW5lLWNvbmRpdGlvbi12YWx1ZXMnXG5cbmNvbnN0IGRlZmF1bHRPcGVyYXRvcnMgPSB7XG4gIGlzOiBpbmxpbmUoJz09JyksXG4gICdpcyBub3QnOiBpbmxpbmUoJyE9Jylcbn1cblxuZnVuY3Rpb24gd2l0aERlZmF1bHRzIChwYXJhbSkge1xuICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgcGFyYW0sIGRlZmF1bHRPcGVyYXRvcnMpXG59XG5cbmNvbnN0IHRleHRCYXNlZEZpZWxkQ3VzdG9taXNhdGlvbnMgPSB7XG4gICdpcyBsb25nZXIgdGhhbic6IGxlbmd0aElzKCc+JyksXG4gICdpcyBzaG9ydGVyIHRoYW4nOiBsZW5ndGhJcygnPCcpLFxuICAnaGFzIGxlbmd0aCc6IGxlbmd0aElzKCc9PScpXG59XG5cbmNvbnN0IGFic29sdXRlRGF0ZVRpbWVPcGVyYXRvcnMgPSB7XG4gIGlzOiBhYnNvbHV0ZURhdGVUaW1lKCc9PScpLFxuICAnaXMgbm90JzogYWJzb2x1dGVEYXRlVGltZSgnIT0nKSxcbiAgJ2lzIGJlZm9yZSc6IGFic29sdXRlRGF0ZVRpbWUoJzwnKSxcbiAgJ2lzIGFmdGVyJzogYWJzb2x1dGVEYXRlVGltZSgnPicpXG59XG5cbmNvbnN0IHJlbGF0aXZlVGltZU9wZXJhdG9ycyA9ICh1bml0cykgPT4gKHtcbiAgJ2lzIGF0IGxlYXN0JzogcmVsYXRpdmVUaW1lKCc8PScsICc+PScsIHVuaXRzKSxcbiAgJ2lzIGF0IG1vc3QnOiByZWxhdGl2ZVRpbWUoJz49JywgJzw9JywgdW5pdHMpLFxuICAnaXMgbGVzcyB0aGFuJzogcmVsYXRpdmVUaW1lKCc+JywgJzwnLCB1bml0cyksXG4gICdpcyBtb3JlIHRoYW4nOiByZWxhdGl2ZVRpbWUoJzwnLCAnPicsIHVuaXRzKVxufSlcblxuZXhwb3J0IGNvbnN0IGN1c3RvbU9wZXJhdG9ycyA9IHtcbiAgQ2hlY2tib3hlc0ZpZWxkOiB7XG4gICAgY29udGFpbnM6IHJldmVyc2VJbmxpbmUoJ2luJyksXG4gICAgJ2RvZXMgbm90IGNvbnRhaW4nOiBub3QocmV2ZXJzZUlubGluZSgnaW4nKSlcbiAgfSxcbiAgTnVtYmVyRmllbGQ6IHdpdGhEZWZhdWx0cyh7XG4gICAgJ2lzIGF0IGxlYXN0JzogaW5saW5lKCc+PScpLFxuICAgICdpcyBhdCBtb3N0JzogaW5saW5lKCc8PScpLFxuICAgICdpcyBsZXNzIHRoYW4nOiBpbmxpbmUoJzwnKSxcbiAgICAnaXMgbW9yZSB0aGFuJzogaW5saW5lKCc+JylcbiAgfSksXG4gIERhdGVGaWVsZDogT2JqZWN0LmFzc2lnbih7fSwgYWJzb2x1dGVEYXRlVGltZU9wZXJhdG9ycywgcmVsYXRpdmVUaW1lT3BlcmF0b3JzKGRhdGVVbml0cykpLFxuICBUaW1lRmllbGQ6IE9iamVjdC5hc3NpZ24oe30sIGFic29sdXRlRGF0ZVRpbWVPcGVyYXRvcnMsIHJlbGF0aXZlVGltZU9wZXJhdG9ycyh0aW1lVW5pdHMpKSxcbiAgRGF0ZVBhcnRzRmllbGQ6IE9iamVjdC5hc3NpZ24oe30sIGFic29sdXRlRGF0ZVRpbWVPcGVyYXRvcnMsIHJlbGF0aXZlVGltZU9wZXJhdG9ycyhkYXRlVW5pdHMpKSxcbiAgRGF0ZVRpbWVGaWVsZDogT2JqZWN0LmFzc2lnbih7fSwgYWJzb2x1dGVEYXRlVGltZU9wZXJhdG9ycywgcmVsYXRpdmVUaW1lT3BlcmF0b3JzKGRhdGVUaW1lVW5pdHMpKSxcbiAgRGF0ZVRpbWVQYXJ0c0ZpZWxkOiBPYmplY3QuYXNzaWduKHt9LCBhYnNvbHV0ZURhdGVUaW1lT3BlcmF0b3JzLCByZWxhdGl2ZVRpbWVPcGVyYXRvcnMoZGF0ZVRpbWVVbml0cykpLFxuICBUZXh0RmllbGQ6IHdpdGhEZWZhdWx0cyh0ZXh0QmFzZWRGaWVsZEN1c3RvbWlzYXRpb25zKSxcbiAgTXVsdGlsaW5lVGV4dEZpZWxkOiB3aXRoRGVmYXVsdHModGV4dEJhc2VkRmllbGRDdXN0b21pc2F0aW9ucyksXG4gIEVtYWlsQWRkcmVzc0ZpZWxkOiB3aXRoRGVmYXVsdHModGV4dEJhc2VkRmllbGRDdXN0b21pc2F0aW9ucylcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wZXJhdG9yTmFtZXMgKGZpZWxkVHlwZSkge1xuICByZXR1cm4gT2JqZWN0LmtleXMoZ2V0Q29uZGl0aW9uYWxzKGZpZWxkVHlwZSkpLnNvcnQoKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RXhwcmVzc2lvbiAoZmllbGRUeXBlLCBmaWVsZE5hbWUsIG9wZXJhdG9yLCB2YWx1ZSkge1xuICByZXR1cm4gZ2V0Q29uZGl0aW9uYWxzKGZpZWxkVHlwZSlbb3BlcmF0b3JdLmV4cHJlc3Npb24oeyB0eXBlOiBmaWVsZFR5cGUsIG5hbWU6IGZpZWxkTmFtZSB9LCB2YWx1ZSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wZXJhdG9yQ29uZmlnIChmaWVsZFR5cGUsIG9wZXJhdG9yKSB7XG4gIHJldHVybiBnZXRDb25kaXRpb25hbHMoZmllbGRUeXBlKVtvcGVyYXRvcl1cbn1cblxuZnVuY3Rpb24gZ2V0Q29uZGl0aW9uYWxzIChmaWVsZFR5cGUpIHtcbiAgcmV0dXJuIGN1c3RvbU9wZXJhdG9yc1tmaWVsZFR5cGVdIHx8IGRlZmF1bHRPcGVyYXRvcnNcbn1cblxuZnVuY3Rpb24gaW5saW5lIChvcGVyYXRvcikge1xuICByZXR1cm4ge1xuICAgIGV4cHJlc3Npb246IChmaWVsZCwgdmFsdWUpID0+IGAke2ZpZWxkLm5hbWV9ICR7b3BlcmF0b3J9ICR7Zm9ybWF0VmFsdWUoZmllbGQudHlwZSwgdmFsdWUudmFsdWUpfWBcbiAgfVxufVxuXG5mdW5jdGlvbiBsZW5ndGhJcyAob3BlcmF0b3IpIHtcbiAgcmV0dXJuIHtcbiAgICBleHByZXNzaW9uOiAoZmllbGQsIHZhbHVlKSA9PiBgbGVuZ3RoKCR7ZmllbGQubmFtZX0pICR7b3BlcmF0b3J9ICR7dmFsdWUudmFsdWV9YFxuICB9XG59XG5cbmZ1bmN0aW9uIHJldmVyc2VJbmxpbmUgKG9wZXJhdG9yKSB7XG4gIHJldHVybiB7XG4gICAgZXhwcmVzc2lvbjogKGZpZWxkLCB2YWx1ZSkgPT4gYCR7Zm9ybWF0VmFsdWUoZmllbGQudHlwZSwgdmFsdWUudmFsdWUpfSAke29wZXJhdG9yfSAke2ZpZWxkLm5hbWV9YFxuICB9XG59XG5cbmZ1bmN0aW9uIG5vdCAob3BlcmF0b3JEZWZpbml0aW9uKSB7XG4gIHJldHVybiB7XG4gICAgZXhwcmVzc2lvbjogKGZpZWxkLCB2YWx1ZSkgPT4gYG5vdCAoJHtvcGVyYXRvckRlZmluaXRpb24uZXhwcmVzc2lvbihmaWVsZCwgdmFsdWUpfSlgXG4gIH1cbn1cblxuZnVuY3Rpb24gZm9ybWF0VmFsdWUgKGZpZWxkVHlwZSwgdmFsdWUpIHtcbiAgaWYgKGZpZWxkVHlwZSA9PT0gJ051bWJlckZpZWxkJyB8fCBmaWVsZFR5cGUgPT09ICdZZXNOb0ZpZWxkJykge1xuICAgIHJldHVybiB2YWx1ZVxuICB9XG4gIHJldHVybiBgJyR7dmFsdWV9J2Bcbn1cblxuZXhwb3J0IGNvbnN0IGFic29sdXRlRGF0ZU9yVGltZU9wZXJhdG9yTmFtZXMgPSBPYmplY3Qua2V5cyhhYnNvbHV0ZURhdGVUaW1lT3BlcmF0b3JzKVxuZXhwb3J0IGNvbnN0IHJlbGF0aXZlRGF0ZU9yVGltZU9wZXJhdG9yTmFtZXMgPSBPYmplY3Qua2V5cyhyZWxhdGl2ZVRpbWVPcGVyYXRvcnMoZGF0ZVRpbWVVbml0cykpXG5cbmZ1bmN0aW9uIGFic29sdXRlRGF0ZVRpbWUgKG9wZXJhdG9yKSB7XG4gIHJldHVybiB7XG4gICAgZXhwcmVzc2lvbjogKGZpZWxkLCB2YWx1ZSkgPT4ge1xuICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ29uZGl0aW9uVmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIGAke2ZpZWxkLm5hbWV9ICR7b3BlcmF0b3J9ICcke3ZhbHVlLnRvRXhwcmVzc2lvbigpfSdgXG4gICAgICB9XG4gICAgICB0aHJvdyBFcnJvcignb25seSBWYWx1ZSB0eXBlcyBhcmUgc3VwcG9ydGVkJylcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVsYXRpdmVUaW1lIChwYXN0T3BlcmF0b3IsIGZ1dHVyZU9wZXJhdG9yLCB1bml0cykge1xuICByZXR1cm4ge1xuICAgIHVuaXRzOiB1bml0cyxcbiAgICBleHByZXNzaW9uOiAoZmllbGQsIHZhbHVlKSA9PiB7XG4gICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZWxhdGl2ZVRpbWVWYWx1ZSkge1xuICAgICAgICBjb25zdCBvcGVyYXRvciA9IHZhbHVlLmRpcmVjdGlvbiA9PT0gZGF0ZURpcmVjdGlvbnMuUEFTVCA/IHBhc3RPcGVyYXRvciA6IGZ1dHVyZU9wZXJhdG9yXG4gICAgICAgIHJldHVybiBgJHtmaWVsZC5uYW1lfSAke29wZXJhdG9yfSAke3ZhbHVlLnRvRXhwcmVzc2lvbigpfWBcbiAgICAgIH1cbiAgICAgIHRocm93IEVycm9yKCd0aW1lIHNoaWZ0IHJlcXVpcmVzIGEgVGltZVNoaWZ0VmFsdWUnKVxuICAgIH1cbiAgfVxufVxuIl19